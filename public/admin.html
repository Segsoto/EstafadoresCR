<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - EstafadoresCR</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 0;
        }
        
        .admin-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .admin-actions {
            display: flex;
            gap: 15px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .back-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #e74c3c;
        }
        
        .reports-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .table-content {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .report-row {
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 100px 120px 150px 1fr 120px 150px;
            gap: 15px;
            align-items: center;
        }
        
        .report-row:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-approve {
            background: #22c55e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background 0.15s ease;
        }
        
        .btn-approve:hover {
            background: #16a34a;
        }
        
        .btn-reject {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background 0.15s ease;
        }
        
        .btn-reject:hover {
            background: #d97706;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background 0.15s ease;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        .report-description {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .report-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .admin-nav {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <div class="admin-nav">
                <div class="admin-title">üõ°Ô∏è Panel de Administraci√≥n - EstafadoresCR</div>
                <div class="admin-actions">
                    <a href="/" class="back-btn">üè† Ir al Sitio</a>
                    <button class="logout-btn" id="logout-btn">üö™ Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Estad√≠sticas -->
            <div class="admin-stats">
                <div class="stat-box">
                    <div class="stat-number" id="total-reports">-</div>
                    <div>Total Reportes</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="active-reports">-</div>
                    <div>Reportes Activos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="pending-reports">-</div>
                    <div>Pendientes</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="rejected-reports">-</div>
                    <div>Rechazados</div>
                </div>
            </div>

            <!-- Tabla de Reportes -->
            <div class="reports-table">
                <div class="table-header">
                    <h2>üìã Gesti√≥n de Reportes</h2>
                    <p>Administra las publicaciones de la plataforma</p>
                </div>
                
                <div class="table-content" id="reports-container">
                    <div class="loading">Cargando reportes...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let adminToken = localStorage.getItem('adminToken');
        
        // Verificar autenticaci√≥n
        if (!adminToken) {
            window.location.href = '/admin/login';
        }
        
        // Cargar datos del admin
        document.addEventListener('DOMContentLoaded', function() {
            loadReports();
            
            // Event listener para el bot√≥n de logout
            document.getElementById('logout-btn').addEventListener('click', logout);
        });
        
        async function loadReports() {
            console.log('üìä Cargando reportes del admin...');
            
            try {
                const response = await fetch('/admin/api/reports', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                console.log('üì° Estado de respuesta:', response.status);
                
                if (response.status === 401) {
                    console.log('üîí Token expirado, redirigiendo a login');
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`‚úÖ Reportes recibidos: ${data.reports.length}`);
                
                displayReports(data.reports);
                updateStats(data.reports);
                
                // Agregar event listeners para los botones de acci√≥n
                setupActionButtons();
                
            } catch (error) {
                console.error('‚ùå Error al cargar reportes:', error);
                document.getElementById('reports-container').innerHTML = 
                    `<div class="error">‚ùå Error al cargar reportes: ${error.message}</div>`;
            }
        }
        
        function displayReports(reports) {
            const container = document.getElementById('reports-container');
            
            if (reports.length === 0) {
                container.innerHTML = '<div class="loading">No hay reportes</div>';
                return;
            }
            
            container.innerHTML = reports.map(report => `
                <div class="report-row" data-id="${report.id}" data-report-id="${report.id}">
                    <div><strong>ID:</strong> ${report.id}</div>
                    <div><strong>üìû</strong> ${report.phone_number}</div>
                    <div><strong>Tipo:</strong> ${getScamTypeLabel(report.scam_type)}</div>
                    <div class="report-description" title="${report.description}">
                        ${report.description}
                    </div>
                    <div>
                        <span class="status-badge status-${report.status || 'pending'}">
                            ${getStatusLabel(report.status)}
                        </span>
                    </div>
                    <div class="action-buttons report-actions">
                        <button class="btn-approve" data-id="${report.id}" data-action="approved">
                            ‚úÖ Aprobar
                        </button>
                        <button class="btn-delete" data-id="${report.id}" data-action="delete">
                            üí• Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function updateStats(reports) {
            const total = reports.length;
            const active = reports.filter(r => r.status === 'active' || !r.status).length;
            const pending = reports.filter(r => !r.status || r.status === 'pending').length;
            const rejected = reports.filter(r => r.status === 'rejected').length;
            
            document.getElementById('total-reports').textContent = total;
            document.getElementById('active-reports').textContent = active;
            document.getElementById('pending-reports').textContent = pending;
            document.getElementById('rejected-reports').textContent = rejected;
        }
        
        function setupActionButtons() {
            // Event listeners para botones de aprobar
            document.querySelectorAll('.btn-approve').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reportId = e.target.dataset.id;
                    updateStatus(reportId, 'approved');
                });
            });
            
            // Event listeners para botones de eliminar
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reportId = e.target.dataset.id;
                    deleteReport(reportId);
                });
            });
        }
        
        async function updateStatus(reportId, status) {
            if (status !== 'approved') {
                console.error('‚ùå Solo se permite aprobar reportes');
                return;
            }
            
            const confirmMessage = '¬øEst√°s seguro de APROBAR este reporte?\n\n‚úÖ El reporte ser√° visible para todos los usuarios.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                console.log(`üîÑ Actualizando reporte ${reportId} a ${status}`);
                
                const response = await fetch(`/admin/api/reports/${reportId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                console.log('üìä Respuesta del servidor:', result);
                
                if (response.ok && result.success) {
                    console.log(`‚úÖ ${result.message}`);
                    
                    // Si fue aprobado, actualizar el estilo visual
                    const reportCard = document.querySelector(`[data-report-id="${reportId}"]`);
                    if (reportCard) {
                        reportCard.style.border = '2px solid #27ae60';
                        reportCard.style.backgroundColor = '#d5f5d5';
                        
                        // Ocultar botones de acci√≥n ya que est√° aprobado
                        const actionButtons = reportCard.querySelectorAll('.btn-approve, .btn-delete');
                        actionButtons.forEach(btn => {
                            btn.style.display = 'none';
                        });
                        
                        // Mostrar indicador de aprobado
                        const statusIndicator = reportCard.querySelector('.status-indicator') || 
                                               document.createElement('div');
                        statusIndicator.className = 'status-indicator approved';
                        statusIndicator.innerHTML = '‚úÖ APROBADO';
                        statusIndicator.style.cssText = `
                            background: #27ae60;
                            color: white;
                            padding: 5px 10px;
                            border-radius: 15px;
                            font-size: 12px;
                            font-weight: bold;
                            margin: 10px 0;
                            display: inline-block;
                        `;
                        
                        if (!reportCard.querySelector('.status-indicator')) {
                            reportCard.querySelector('.report-actions').prepend(statusIndicator);
                        }
                    }
                    
                    showNotification(`‚úÖ Reporte aprobado y visible en la p√°gina principal`, 'success');
                } else {
                    console.error('‚ùå Error del servidor:', result);
                    showNotification(`‚ùå Error: ${result.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showNotification('‚ùå Error de conexi√≥n con el servidor', 'error');
            }
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            // Crear o usar contenedor de notificaciones existente
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    pointer-events: none;
                `;
                document.body.appendChild(container);
            }

            // Crear notificaci√≥n
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                margin-bottom: 10px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                font-weight: 500;
                pointer-events: auto;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;

            container.appendChild(notification);

            // Animar entrada
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);

            // Auto-remover despu√©s de 4 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }
        
        async function deleteReport(reportId) {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de ELIMINAR PERMANENTEMENTE este reporte?\n\nüö® ATENCI√ìN: Esta acci√≥n NO se puede deshacer\n\nüí• Se eliminar√° COMPLETAMENTE de la base de datos:\n- El reporte\n- Todos los comentarios\n- Todos los votos\n- Todo el historial\n\nüî• No quedar√° rastro para auditor√≠a\n\n¬øContinuar con la eliminaci√≥n permanente?')) {
                return;
            }
            
            try {
                console.log(`üóëÔ∏è Eliminando PERMANENTEMENTE reporte ${reportId}`);
                
                const response = await fetch(`/admin/api/reports/${reportId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const result = await response.json();
                console.log('üìä Respuesta del servidor:', result);
                
                if (response.ok && result.success) {
                    console.log(`‚úÖ ${result.message}`);
                    
                    // Remover el reporte de la vista inmediatamente
                    console.log(`üéØ Buscando reporte para eliminar con ID: ${reportId}`);
                    const reportCard = document.querySelector(`[data-report-id="${reportId}"]`);
                    console.log('üîç Elemento encontrado para eliminar:', reportCard);
                    
                    if (reportCard) {
                        console.log(`‚úÖ Eliminando reporte ${reportId} de la vista`);
                        reportCard.style.transition = 'all 0.3s ease';
                        reportCard.style.opacity = '0';
                        reportCard.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            reportCard.remove();
                            console.log(`ÔøΩ Reporte ${reportId} ELIMINADO PERMANENTEMENTE`);
                        }, 300);
                    } else {
                        console.warn(`‚ö†Ô∏è No se encontr√≥ el elemento para eliminar con data-report-id="${reportId}"`);
                    }
                    
                    showNotification('üí• Reporte eliminado PERMANENTEMENTE de la base de datos', 'error');
                } else {
                    console.error('‚ùå Error del servidor:', result);
                    showNotification(`‚ùå Error al eliminar reporte: ${result.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showNotification('‚ùå Error de conexi√≥n con el servidor', 'error');
            }
        }
        
        function getScamTypeLabel(type) {
            const types = {
                'simpe': 'SIMPE',
                'familiar': 'Falso Familiar',
                'phishing': 'Phishing',
                'premio': 'Falso Premio',
                'trabajo': 'Trabajo',
                'inversion': 'Inversi√≥n',
                'gobierno': 'Gobierno',
                'delivery': 'Delivery',
                'prestamo': 'Pr√©stamo',
                'otro': 'Otro'
            };
            return types[type] || type;
        }
        
        function getStatusLabel(status) {
            const labels = {
                'active': 'Activo',
                'rejected': 'Rechazado',
                'pending': 'Pendiente'
            };
            return labels[status] || 'Pendiente';
        }
        
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
        }
    </script>
</body>
</html>
